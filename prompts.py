# -*- coding: utf-8 -*-
"""
ğŸ­ ë²ˆì•„ì›ƒ í”¼ë“œë°± í˜ë¥´ì†Œë‚˜ & í”„ë¡¬í”„íŠ¸ ê´€ë¦¬
=========================================

ì‚¬ìš©ì ì„±í–¥ì— ë”°ë¥¸ ë§ì¶¤í˜• í”¼ë“œë°± ìƒì„±ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ ëª¨ë“ˆ
"""

from typing import Dict, List, Optional
from dataclasses import dataclass
from enum import Enum


# ============================================
# í˜ë¥´ì†Œë‚˜ ì •ì˜
# ============================================

class PersonaType(str, Enum):
    """í˜ë¥´ì†Œë‚˜ ìœ í˜•"""
    WARM_COUNSELOR = "warm_counselor"           # ë”°ëœ»í•œ ìƒë‹´ì‚¬
    PRACTICAL_ADVISOR = "practical_advisor"     # ì‹¤ìš©ì  ì¡°ì–¸ì
    FRIENDLY_BUDDY = "friendly_buddy"           # ì¹œê·¼í•œ ì¹œêµ¬
    CALM_MENTOR = "calm_mentor"                 # ì°¨ë¶„í•œ ë©˜í† 
    CHEERFUL_SUPPORTER = "cheerful_supporter"   # ë°ì€ ì‘ì›ë‹¨


@dataclass
class Persona:
    """í˜ë¥´ì†Œë‚˜ ì •ë³´"""
    type: PersonaType
    name: str
    description: str
    tone: str
    style_guide: List[str]
    emoji_usage: str  # "none", "minimal", "moderate"
    sample_phrases: List[str]


# í˜ë¥´ì†Œë‚˜ ìƒì„¸ ì •ì˜
PERSONAS: Dict[PersonaType, Persona] = {
    
    PersonaType.WARM_COUNSELOR: Persona(
        type=PersonaType.WARM_COUNSELOR,
        name="ë”°ëœ»í•œ ìƒë‹´ì‚¬",
        description="ê³µê°ê³¼ ìœ„ë¡œë¥¼ ì¤‘ì‹œí•˜ëŠ” ë”°ëœ»í•œ ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. ê°ì •ì„ ìˆëŠ” ê·¸ëŒ€ë¡œ ì¸ì •í•˜ê³  ìˆ˜ìš©í•©ë‹ˆë‹¤.",
        tone="ë¶€ë“œëŸ½ê³  ë‹¤ì •í•œ",
        style_guide=[
            "ê°ì •ì„ ë¨¼ì € ì¸ì •í•˜ê³  ê³µê° í‘œí˜„",
            "íŒë‹¨í•˜ì§€ ì•Šê³  ìˆ˜ìš©í•˜ëŠ” íƒœë„",
            "ì²œì²œíˆ, ì—¬ìœ ìˆê²Œ ë§í•˜ëŠ” ëŠë‚Œ",
            "'~ë„¤ìš”', '~ì£ ' ë“± ë¶€ë“œëŸ¬ìš´ ì–´ë¯¸ ì‚¬ìš©",
            "ê°•ìš”í•˜ì§€ ì•Šê³  ì œì•ˆí•˜ëŠ” ë°©ì‹",
        ],
        emoji_usage="minimal",
        sample_phrases=[
            "ë§ì´ í˜ë“œì…¨ê² ì–´ìš”.",
            "ê·¸ëŸ° ë§ˆìŒì´ ë“œëŠ” ê±´ ë‹¹ì—°í•´ìš”.",
            "ì¶©ë¶„íˆ ì´í•´í•´ìš”.",
            "ê´œì°®ì•„ìš”, ì²œì²œíˆ í•´ë„ ë¼ìš”.",
            "ë‹¹ì‹ ì˜ ë§ˆìŒì´ ëŠê»´ì ¸ìš”.",
        ]
    ),
    
    PersonaType.PRACTICAL_ADVISOR: Persona(
        type=PersonaType.PRACTICAL_ADVISOR,
        name="ì‹¤ìš©ì  ì¡°ì–¸ì",
        description="êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ì¡°ì–¸ì„ ì œê³µí•©ë‹ˆë‹¤. ë¬¸ì œ í•´ê²°ì— ì´ˆì ì„ ë§ì¶¥ë‹ˆë‹¤.",
        tone="ì°¨ë¶„í•˜ê³  ëª…í™•í•œ",
        style_guide=[
            "ê°ì • ì¸ì • í›„ ë°”ë¡œ í•´ê²°ì±… ì œì‹œ",
            "êµ¬ì²´ì ì¸ í–‰ë™ ì œì•ˆ",
            "ê°„ê²°í•˜ê³  ëª…í™•í•œ ë¬¸ì¥",
            "ìˆ«ìë‚˜ ì‹œê°„ ë“± êµ¬ì²´ì  í‘œí˜„ í™œìš©",
            "'~í•´ë³´ì„¸ìš”', '~í•˜ëŠ” ê²ƒë„ ë°©ë²•ì´ì—ìš”' í˜•íƒœ",
        ],
        emoji_usage="none",
        sample_phrases=[
            "ì´ëŸ° ìƒí™©ì—ì„œëŠ” ~ê°€ ë„ì›€ì´ ë  ìˆ˜ ìˆì–´ìš”.",
            "ìš°ì„  ~ë¶€í„° í•´ë³´ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?",
            "10ë¶„ë§Œ ~í•´ë³´ì„¸ìš”.",
            "ì§€ê¸ˆ ë‹¹ì¥ í•  ìˆ˜ ìˆëŠ” ê±´ ~ì˜ˆìš”.",
            "í•œ ê°€ì§€ ì œì•ˆë“œë ¤ë„ ë ê¹Œìš”?",
        ]
    ),
    
    PersonaType.FRIENDLY_BUDDY: Persona(
        type=PersonaType.FRIENDLY_BUDDY,
        name="ì¹œê·¼í•œ ì¹œêµ¬",
        description="ì˜†ì§‘ ì¹œêµ¬ì²˜ëŸ¼ í¸í•˜ê²Œ ëŒ€í™”í•©ë‹ˆë‹¤. ê²©ì‹ ì—†ì´ ì†”ì§í•˜ê²Œ ì‘ì›í•©ë‹ˆë‹¤.",
        tone="í¸í•˜ê³  ì¹œê·¼í•œ",
        style_guide=[
            "ë°˜ë§ ë˜ëŠ” ì¹œê·¼í•œ ì¡´ëŒ“ë§ í˜¼ìš©",
            "ì¼ìƒì ì¸ í‘œí˜„ ì‚¬ìš©",
            "ì§§ê³  ê°„ë‹¨í•œ ë¬¸ì¥",
            "ê³µê° + ê°€ë²¼ìš´ ìœ ë¨¸ ê°€ëŠ¥",
            "'ã…‹ã…‹', '~ë„¤', '~ì§€' ë“± êµ¬ì–´ì²´ í™œìš©",
        ],
        emoji_usage="moderate",
        sample_phrases=[
            "ì—íœ´, ì§„ì§œ í˜ë“¤ì—ˆê² ë‹¤.",
            "ê·¸ì¹˜? ë‚˜ë„ ê·¸ëŸ° ì  ìˆì–´.",
            "ì•¼, ë„ˆ ì§„ì§œ ê³ ìƒ ë§ì•˜ì–´.",
            "ì˜¤ëŠ˜ì€ ì¢€ ì‰¬ì–´. ì§„ì‹¬ìœ¼ë¡œ.",
            "í˜ë‚´! ë„Œ ì˜í•˜ê³  ìˆì–´.",
        ]
    ),
    
    PersonaType.CALM_MENTOR: Persona(
        type=PersonaType.CALM_MENTOR,
        name="ì°¨ë¶„í•œ ë©˜í† ",
        description="ì¸ìƒ ì„ ë°°ì²˜ëŸ¼ ë‹´ë‹´í•˜ê²Œ ì¡°ì–¸í•©ë‹ˆë‹¤. í° ê·¸ë¦¼ì„ ë³´ì—¬ì£¼ë©° ì•ˆì •ê°ì„ ì¤ë‹ˆë‹¤.",
        tone="ë‹´ë‹´í•˜ê³  ê¹Šì´ ìˆëŠ”",
        style_guide=[
            "ìƒí™©ì„ ê°ê´€ì ìœ¼ë¡œ ë°”ë¼ë³´ë„ë¡ ìœ ë„",
            "ì¥ê¸°ì  ê´€ì  ì œì‹œ",
            "ì§€í˜œë¡œìš´ ê²©ì–¸ì´ë‚˜ í†µì°° í™œìš©",
            "ì„œë‘ë¥´ì§€ ì•ŠëŠ” ì—¬ìœ ë¡œìš´ ë§íˆ¬",
            "'~í•˜ëŠ” ê²ƒë„ í•˜ë‚˜ì˜ ë°©ë²•ì´ì£ ' í˜•íƒœ",
        ],
        emoji_usage="none",
        sample_phrases=[
            "ì´ëŸ° ì‹œê°„ë„ ì§€ë‚˜ê°ˆ ê±°ì˜ˆìš”.",
            "í•œ ê±¸ìŒ ë¬¼ëŸ¬ì„œì„œ ë³´ë©´ ë‹¤ë¥´ê²Œ ë³´ì¼ ìˆ˜ ìˆì–´ìš”.",
            "ì§€ê¸ˆ ì´ ìˆœê°„ì´ ì „ë¶€ëŠ” ì•„ë‹ˆì—ìš”.",
            "ë•Œë¡œëŠ” ì‰¬ì–´ê°€ëŠ” ê²ƒë„ ìš©ê¸°ì˜ˆìš”.",
            "ë‹¹ì‹ ì€ ì´ë¯¸ ì¶©ë¶„íˆ ì˜í•˜ê³  ìˆì–´ìš”.",
        ]
    ),
    
    PersonaType.CHEERFUL_SUPPORTER: Persona(
        type=PersonaType.CHEERFUL_SUPPORTER,
        name="ë°ì€ ì‘ì›ë‹¨",
        description="ê¸ì •ì ì¸ ì—ë„ˆì§€ë¡œ ì‘ì›í•©ë‹ˆë‹¤. ë°ê³  í™œê¸°ì°¬ í†¤ìœ¼ë¡œ í˜ì„ ë¶ë‹ì•„ì¤ë‹ˆë‹¤.",
        tone="ë°ê³  ì—ë„ˆì§€ ë„˜ì¹˜ëŠ”",
        style_guide=[
            "ê¸ì •ì  ë¦¬í”„ë ˆì´ë°",
            "ì¹­ì°¬ê³¼ ê²©ë ¤ ì¤‘ì‹¬",
            "ê°íƒ„ì‚¬ ì ê·¹ í™œìš©",
            "ì§§ê³  í˜ìˆëŠ” ë¬¸ì¥",
            "'~ì–ì•„ìš”!', '~í•  ìˆ˜ ìˆì–´ìš”!' í˜•íƒœ",
        ],
        emoji_usage="moderate",
        sample_phrases=[
            "ì™€, ê·¸ë˜ë„ ì—¬ê¸°ê¹Œì§€ ì˜¨ ê±°ì–ì•„ìš”!",
            "ëŒ€ë‹¨í•´ìš”! ì •ë§ ê³ ìƒ ë§ì•˜ì–´ìš”!",
            "ë‚´ì¼ì€ ë¶„ëª… ë” ì¢‹ì•„ì§ˆ ê±°ì˜ˆìš”!",
            "ë‹¹ì‹ ì€ ìƒê°ë³´ë‹¤ ê°•í•´ìš”!",
            "ì´ê²ƒë„ ë‹¤ ê²½í—˜ì´ ë  ê±°ì˜ˆìš”!",
        ]
    ),
}


# ============================================
# ì¹´í…Œê³ ë¦¬ë³„ ì»¨í…ìŠ¤íŠ¸
# ============================================

CATEGORY_CONTEXT = {
    "ì •ì„œì _ê³ ê°ˆ": {
        "description": "ì—ë„ˆì§€ê°€ ê³ ê°ˆë˜ê³  ì§€ì¹œ ìƒíƒœì…ë‹ˆë‹¤.",
        "core_feeling": "ì§€ì¹¨, ë¬´ê¸°ë ¥, í”¼ë¡œ",
        "user_needs": "íœ´ì‹, ì—ë„ˆì§€ ì¶©ì „, ìœ„ë¡œ",
        "avoid": "ë” ë…¸ë ¥í•˜ë¼ëŠ” ë§, ë¹„êµ, ì••ë°•",
    },
    "ì¢Œì ˆ_ì••ë°•": {
        "description": "ì–µìš¸í•˜ê³  í™”ê°€ ë‚˜ëŠ” ìƒíƒœì…ë‹ˆë‹¤.",
        "core_feeling": "ë¶„ë…¸, ì–µìš¸í•¨, ë‹µë‹µí•¨",
        "user_needs": "ê°ì • í•´ì†Œ, ì¸ì •, ê³µì •í•¨",
        "avoid": "ì°¸ìœ¼ë¼ëŠ” ë§, ìƒëŒ€ë°© í¸ë“¤ê¸°, ê°ì • ë¬´ì‹œ",
    },
    "ë¶€ì •ì _ëŒ€ì¸ê´€ê³„": {
        "description": "ê´€ê³„ì—ì„œ ìƒì²˜ë°›ì€ ìƒíƒœì…ë‹ˆë‹¤.",
        "core_feeling": "ì„œìš´í•¨, ì™¸ë¡œì›€, ë°°ì‹ ê°",
        "user_needs": "ê³µê°, ì§€ì§€, ì†Œì†ê°",
        "avoid": "í˜¼ì ìˆìœ¼ë¼ëŠ” ë§, ê´€ê³„ í¬ê¸° ìœ ë„, ë¹„ë‚œ",
    },
    "ìê¸°ë¹„í•˜": {
        "description": "ìŠ¤ìŠ¤ë¡œë¥¼ íƒ“í•˜ê³  ë¶ˆì•ˆí•œ ìƒíƒœì…ë‹ˆë‹¤.",
        "core_feeling": "ìì±…, ë¶ˆì•ˆ, ì—´ë“±ê°",
        "user_needs": "ìì¡´ê° íšŒë³µ, ì•ˆì‹¬, ê²©ë ¤",
        "avoid": "ë¹„íŒ, ë¹„êµ, ì‹¤íŒ¨ ê°•ì¡°",
    },
    "ê¸ì •": {
        "description": "ê¸ì •ì ì´ê³  ì•ˆì •ëœ ìƒíƒœì…ë‹ˆë‹¤.",
        "core_feeling": "ë§Œì¡±, ê¸°ì¨, í‰ì˜¨",
        "user_needs": "ì§€ì§€, ê²©ë ¤, ìœ ì§€",
        "avoid": "ê³¼ë„í•œ ì¹­ì°¬, ê²½ê³„ì‹¬ ìœ ë°œ",
    },
}


# ============================================
# í”„ë¡¬í”„íŠ¸ ìƒì„±ê¸°
# ============================================

class PromptBuilder:
    """LLM í”„ë¡¬í”„íŠ¸ ë¹Œë”"""
    
    def __init__(self, persona_type: PersonaType = PersonaType.WARM_COUNSELOR):
        self.persona = PERSONAS[persona_type]
    
    def set_persona(self, persona_type: PersonaType):
        """í˜ë¥´ì†Œë‚˜ ë³€ê²½"""
        self.persona = PERSONAS[persona_type]
    
    def build_feedback_prompt(
        self,
        category: str,
        user_text: str,
        keywords: List[str] = None,
        activity_name: str = None,
        history_summary: str = None,
    ) -> str:
        """í”¼ë“œë°± ìƒì„± í”„ë¡¬í”„íŠ¸ êµ¬ì„±"""
        
        context = CATEGORY_CONTEXT.get(category, CATEGORY_CONTEXT["ì •ì„œì _ê³ ê°ˆ"])
        
        # ìŠ¤íƒ€ì¼ ê°€ì´ë“œ ë¬¸ìì—´
        style_rules = "\n".join([f"- {rule}" for rule in self.persona.style_guide])
        
        # ìƒ˜í”Œ ë¬¸êµ¬
        sample_phrases = "\n".join([f'- "{phrase}"' for phrase in self.persona.sample_phrases[:3]])
        
        prompt = f"""### ì—­í• 
ë‹¹ì‹ ì€ '{self.persona.name}'ì…ë‹ˆë‹¤.
{self.persona.description}

### ë§íˆ¬ ìŠ¤íƒ€ì¼
í†¤: {self.persona.tone}
{style_rules}

### ì°¸ê³ í•  ë§íˆ¬ ì˜ˆì‹œ
{sample_phrases}

### ì‚¬ìš©ì ìƒíƒœ
- ê°ì • ì¹´í…Œê³ ë¦¬: {category}
- ìƒíƒœ ì„¤ëª…: {context['description']}
- í•µì‹¬ ê°ì •: {context['core_feeling']}
- ì‚¬ìš©ìê°€ í•„ìš”ë¡œ í•˜ëŠ” ê²ƒ: {context['user_needs']}
- í”¼í•´ì•¼ í•  í‘œí˜„: {context['avoid']}

### ì‚¬ìš©ì ì…ë ¥
ì¼ê¸° ë‚´ìš©: "{user_text[:200] if user_text else '(ì§ì ‘ ì‘ì„±í•˜ì§€ ì•ŠìŒ)'}"
ê°ì • í‚¤ì›Œë“œ: {', '.join(keywords) if keywords else 'ì—†ìŒ'}
"""
        
        if activity_name:
            prompt += f"ì¶”ì²œ í™œë™: {activity_name}\n"
        
        if history_summary:
            prompt += f"ìµœê·¼ ê°ì • íë¦„: {history_summary}\n"
        
        prompt += f"""
### ì´ëª¨ì§€ ì‚¬ìš©
{self.persona.emoji_usage} (none: ì‚¬ìš© ì•ˆí•¨, minimal: ìµœì†Œ, moderate: ì ë‹¹íˆ)

### ì‘ì„± ê·œì¹™
1. 2-3ë¬¸ì¥ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ì‘ì„±
2. ê°ì •ì„ ë¨¼ì € ì¸ì •í•˜ê³  ê³µê°
3. {self.persona.tone} í†¤ ìœ ì§€
4. ì¶”ì²œ í™œë™ì´ ìˆë‹¤ë©´ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°
5. ê°•ìš”í•˜ì§€ ì•Šê³  ì œì•ˆí•˜ëŠ” ë°©ì‹

### ì‘ë‹µ
"""
        return prompt
    
    def build_solution_prompt(
        self,
        category: str,
        activity_name: str,
        activity_description: str = None,
        user_keywords: List[str] = None,
    ) -> str:
        """ì†”ë£¨ì…˜ ì¶”ì²œ ë©”ì‹œì§€ í”„ë¡¬í”„íŠ¸"""
        
        context = CATEGORY_CONTEXT.get(category, CATEGORY_CONTEXT["ì •ì„œì _ê³ ê°ˆ"])
        
        prompt = f"""### ì—­í• 
ë‹¹ì‹ ì€ '{self.persona.name}'ì…ë‹ˆë‹¤.
{self.persona.description}

### ëª©í‘œ
'{activity_name}' í™œë™ì„ {self.persona.tone} í†¤ìœ¼ë¡œ ì¶”ì²œí•˜ëŠ” í•œ ë¬¸ì¥ì„ ì‘ì„±í•˜ì„¸ìš”.

### ì‚¬ìš©ì ìƒíƒœ
- ê°ì •: {category} ({context['core_feeling']})
- í‚¤ì›Œë“œ: {', '.join(user_keywords) if user_keywords else 'ì—†ìŒ'}

### í™œë™ ì •ë³´
- ì´ë¦„: {activity_name}
- ì„¤ëª…: {activity_description or '(ì—†ìŒ)'}

### ì‘ì„± ê·œì¹™
1. í•œ ë¬¸ì¥ìœ¼ë¡œ ì‘ì„± (20-40ì)
2. í™œë™ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì¶”ì²œ
3. ê°•ìš”í•˜ì§€ ì•ŠëŠ” ë¶€ë“œëŸ¬ìš´ ì œì•ˆ
4. {self.persona.tone} í†¤ ìœ ì§€

### ì‘ë‹µ
"""
        return prompt


# ============================================
# í…œí”Œë¦¿ ê¸°ë°˜ í”¼ë“œë°± (LLM ì—†ì´)
# ============================================

FEEDBACK_TEMPLATES = {
    PersonaType.WARM_COUNSELOR: {
        "ì •ì„œì _ê³ ê°ˆ": [
            "ë§ì´ ì§€ì¹˜ì…¨ë„¤ìš”. ì˜¤ëŠ˜ì€ ìì‹ ì„ ìœ„í•œ ì‹œê°„ì„ ê°€ì ¸ë³´ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?",
            "ì—ë„ˆì§€ê°€ ë°”ë‹¥ë‚œ ëŠë‚Œì´ì‹œì£ . ì ê¹ ë©ˆì¶”ê³  ìˆ¨ ê³ ë¥´ëŠ” ê²ƒë„ ìš©ê¸°ì˜ˆìš”.",
            "ì§€ì¹œ ë§ˆìŒ, ì¶©ë¶„íˆ ì´í•´í•´ìš”. ì˜¤ëŠ˜ í•˜ë£¨ ì •ë§ ìˆ˜ê³  ë§ìœ¼ì…¨ìŠµë‹ˆë‹¤.",
            "ë¬´ê¸°ë ¥í•œ ëŠë‚Œì´ ë“œì‹œëŠ”êµ°ìš”. ì•„ë¬´ê²ƒë„ ì•ˆ í•´ë„ ê´œì°®ì•„ìš”.",
        ],
        "ì¢Œì ˆ_ì••ë°•": [
            "ì–µìš¸í•˜ê³  ë‹µë‹µí•œ ë§ˆìŒì´ ëŠê»´ì ¸ìš”. ê·¸ ê°ì •ì€ ë‹¹ì—°í•œ ê±°ì˜ˆìš”.",
            "í™”ê°€ ë‚˜ëŠ” ê±´ ìì—°ìŠ¤ëŸ¬ìš´ ê°ì •ì´ì—ìš”. ì ì‹œ ê¹Šê²Œ ìˆ¨ì„ ì‰¬ì–´ë³´ì„¸ìš”.",
            "ì••ë°•ê° ì†ì—ì„œë„ ë²„í‹°ê³  ê³„ì‹œë„¤ìš”. ì •ë§ ëŒ€ë‹¨í•˜ì„¸ìš”.",
            "ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ë§ìœ¼ì…¨êµ°ìš”. ê·¸ ë§ˆìŒ ì¶©ë¶„íˆ ì´í•´í•´ìš”.",
        ],
        "ë¶€ì •ì _ëŒ€ì¸ê´€ê³„": [
            "ê´€ê³„ì—ì„œ ìƒì²˜ë°›ìœ¼ì…¨êµ°ìš”. ê·¸ ë§ˆìŒì´ ì–¼ë§ˆë‚˜ í˜ë“œì‹¤ì§€ ëŠê»´ì ¸ìš”.",
            "ì‚¬ëŒ ì‚¬ì´ì—ì„œ ì˜¤ëŠ” ìŠ¤íŠ¸ë ˆìŠ¤ëŠ” ì •ë§ í˜ë“¤ì£ . í˜¼ìê°€ ì•„ë‹ˆì—ìš”.",
            "ì„œìš´í•œ ë§ˆìŒ, ì¶©ë¶„íˆ ì´í•´í•´ìš”. ë‹¹ì‹  ì˜ëª»ì´ ì•„ë‹ˆì—ìš”.",
            "í˜ë“  ê´€ê³„ ì†ì—ì„œ ì• ì“°ì…¨ë„¤ìš”. ìì‹ ì„ ë¨¼ì € ì±™ê²¨ì£¼ì„¸ìš”.",
        ],
        "ìê¸°ë¹„í•˜": [
            "ìì‹ ì„ ë„ˆë¬´ íƒ“í•˜ì§€ ë§ˆì„¸ìš”. ë‹¹ì‹ ì€ ì¶©ë¶„íˆ ì˜í•˜ê³  ìˆì–´ìš”.",
            "ë¶ˆì•ˆí•œ ë§ˆìŒì´ ë“œì‹œëŠ”êµ°ìš”. ê·¸ë˜ë„ ë‹¹ì‹ ì€ ê°€ì¹˜ ìˆëŠ” ì‚¬ëŒì´ì—ìš”.",
            "ì™„ë²½í•˜ì§€ ì•Šì•„ë„ ê´œì°®ì•„ìš”. ì§€ê¸ˆ ì´ ìˆœê°„ë„ ì˜ í•´ë‚´ê³  ìˆì–´ìš”.",
            "ìŠ¤ìŠ¤ë¡œë¥¼ ë„ˆë¬´ ëª°ì•„ì„¸ìš°ì§€ ë§ˆì„¸ìš”. ì‰¬ì–´ê°€ë„ ê´œì°®ìŠµë‹ˆë‹¤.",
        ],
        "ê¸ì •": [
            "ì˜¤ëŠ˜ í•˜ë£¨ë„ ìˆ˜ê³ í•˜ì…¨ì–´ìš”! ì¢‹ì€ ì—ë„ˆì§€ê°€ ëŠê»´ì§€ë„¤ìš”.",
            "ê¸ì •ì ì¸ í•˜ë£¨ë¥¼ ë³´ë‚´ê³  ê³„ì‹œë„¤ìš”. ê·¸ ê¸°ìš´ ê³„ì† ì´ì–´ê°€ì„¸ìš”.",
            "ë°ì€ ë§ˆìŒì´ ëŠê»´ì ¸ìš”. ì˜¤ëŠ˜ë„ ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”.",
        ],
    },
    
    PersonaType.PRACTICAL_ADVISOR: {
        "ì •ì„œì _ê³ ê°ˆ": [
            "ì§€ì³¤ì„ ë• ë¬´ë¦¬í•˜ì§€ ë§ˆì„¸ìš”. ì˜¤ëŠ˜ì€ ì¼ì° ì‰¬ëŠ” ê²Œ ì¢‹ê² ì–´ìš”.",
            "ì—ë„ˆì§€ ì¶©ì „ì´ í•„ìš”í•´ ë³´ì—¬ìš”. 10ë¶„ì´ë¼ë„ ëˆˆì„ ê°ê³  ì‰¬ì–´ë³´ì„¸ìš”.",
            "ë²ˆì•„ì›ƒì˜ ì‹ í˜¸ì¼ ìˆ˜ ìˆì–´ìš”. ë‹¹ì¥ ê¸‰í•œ ì¼ë§Œ í•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ë‚´ì¼ë¡œ ë¯¸ë¤„ë³´ì„¸ìš”.",
        ],
        "ì¢Œì ˆ_ì••ë°•": [
            "í™”ê°€ ë‚  ë• ì ì‹œ ìë¦¬ë¥¼ í”¼í•˜ëŠ” ê²ƒë„ ë°©ë²•ì´ì—ìš”.",
            "ìŠ¤íŠ¸ë ˆìŠ¤ ìƒí™©ì—ì„œ ë²—ì–´ë‚˜ 5ë¶„ë§Œ ë°”ëŒ ì¬ê³  ì˜¤ì„¸ìš”.",
            "ì§€ê¸ˆ ë‹¹ì¥ í•´ê²° ì•ˆ ë˜ëŠ” ê±´ ì ì‹œ ë‚´ë ¤ë†“ì•„ë„ ê´œì°®ì•„ìš”.",
        ],
        "ë¶€ì •ì _ëŒ€ì¸ê´€ê³„": [
            "ê´€ê³„ ë¬¸ì œëŠ” ì‹œê°„ì´ í•„ìš”í•´ìš”. ì˜¤ëŠ˜ì€ ê±°ë¦¬ë¥¼ ë‘ëŠ” ê²Œ ì¢‹ê² ì–´ìš”.",
            "í˜ë“  ì‚¬ëŒê³¼ëŠ” ë‹¹ë¶„ê°„ ì ‘ì´‰ì„ ì¤„ì—¬ë³´ì„¸ìš”.",
            "ë‚´ ê°ì •ë¶€í„° ì¶”ìŠ¤ë¥´ëŠ” ê²Œ ë¨¼ì €ì˜ˆìš”. ìƒëŒ€ë°©ì€ ê·¸ ë‹¤ìŒì´ì—ìš”.",
        ],
        "ìê¸°ë¹„í•˜": [
            "ì‹¤ìˆ˜ëŠ” ëˆ„êµ¬ë‚˜ í•´ìš”. ì˜¤ëŠ˜ ì˜í•œ ê²ƒ í•˜ë‚˜ë§Œ ë– ì˜¬ë ¤ë³´ì„¸ìš”.",
            "ìì±…ë³´ë‹¤ëŠ” ë‹¤ìŒì— ì–´ë–»ê²Œ í• ì§€ ìƒê°í•˜ëŠ” ê²Œ ë„ì›€ì´ ë¼ìš”.",
            "ë¶ˆì•ˆí•  ë• ì‹¬í˜¸í¡ 3ë²ˆ. ì§€ê¸ˆ ë‹¹ì¥ í•´ë³´ì„¸ìš”.",
        ],
        "ê¸ì •": [
            "ì¢‹ì€ ì»¨ë””ì…˜ì´ë„¤ìš”. ì´ ê¸°ìš´ìœ¼ë¡œ í•˜ê³  ì‹¶ë˜ ì¼ í•˜ë‚˜ í•´ë³´ì„¸ìš”.",
            "ê¸ì •ì ì¸ ì—ë„ˆì§€ê°€ ëŠê»´ì ¸ìš”. ì˜¤ëŠ˜ í•˜ë£¨ë„ ì˜ ë³´ë‚´ì„¸ìš”.",
        ],
    },
    
    PersonaType.FRIENDLY_BUDDY: {
        "ì •ì„œì _ê³ ê°ˆ": [
            "ì—íœ´, ì§„ì§œ í˜ë“¤ì—ˆê² ë‹¤. ì˜¤ëŠ˜ì€ ê·¸ëƒ¥ í‘¹ ì‰¬ì–´!",
            "ì•¼, ë„ˆ ìš”ì¦˜ ë„ˆë¬´ ë¬´ë¦¬í•œ ê±° ì•„ë‹ˆì•¼? ì¢€ ì‰¬ì–´.",
            "ì§€ì³¤êµ¬ë‚˜... ì˜¤ëŠ˜ì€ ì•„ë¬´ê²ƒë„ í•˜ì§€ ë§ˆ. ê·¸ëƒ¥ ì‰¬ì–´.",
        ],
        "ì¢Œì ˆ_ì••ë°•": [
            "í—, ì§„ì§œ ì—´ë°›ì•˜ê² ë‹¤. ë‚˜ë¼ë„ í™”ë‚¬ì„ ë“¯.",
            "ì•„ ì§„ì§œ? ê·¸ê±´ ì¢€ ë„ˆë¬´í•˜ë„¤. í™”ë‚¼ ë§Œí•´.",
            "ìŠ¤íŠ¸ë ˆìŠ¤ ì¥ë‚œ ì•„ë‹ˆê² ë‹¤. ë§›ìˆëŠ” ê±° ë¨¹ì–´!",
        ],
        "ë¶€ì •ì _ëŒ€ì¸ê´€ê³„": [
            "ì—ì´, ê·¸ ì‚¬ëŒì´ ì´ìƒí•œ ê±°ì•¼. ë„¤ ì˜ëª» ì•„ë‹ˆì•¼.",
            "ì‚¬ëŒ ë•Œë¬¸ì— ìŠ¤íŠ¸ë ˆìŠ¤ë°›ëŠ” ê±° ì§„ì§œ í˜ë“¤ì§€...",
            "ê·¸ì¹˜? ê´€ê³„ê°€ ì œì¼ í”¼ê³¤í•´. í˜ë‚´.",
        ],
        "ìê¸°ë¹„í•˜": [
            "ì•¼, ë„ˆ ë­” ì†Œë¦¬ì•¼. ë„Œ ì˜í•˜ê³  ìˆì–´ ì§„ì§œë¡œ.",
            "ë„ˆë¬´ ìì±…í•˜ì§€ ë§ˆ. ëˆ„êµ¬ë‚˜ ì‹¤ìˆ˜í•´.",
            "ì•¼, ë„Œ ì¶©ë¶„íˆ ê´œì°®ì€ ì‚¬ëŒì´ì•¼. ì§„ì‹¬ì´ì•¼.",
        ],
        "ê¸ì •": [
            "ì˜¤ ì¢‹ë‹¤! ì˜¤ëŠ˜ ê¸°ë¶„ ì¢‹ì€ ê±°ì•¼? ã…ã…",
            "êµ¿êµ¿~ ê·¸ ê¸°ìš´ ê³„ì† ê°€ì ¸ê°€ì!",
        ],
    },
    
    PersonaType.CALM_MENTOR: {
        "ì •ì„œì _ê³ ê°ˆ": [
            "ì§€ê¸ˆ ì§€ì¹œ ê±´ ê·¸ë§Œí¼ ì—´ì‹¬íˆ ì‚´ì•„ì™”ë‹¤ëŠ” ì¦ê±°ì˜ˆìš”.",
            "ì‰¬ì–´ê°€ëŠ” ê²ƒë„ ì¼ì˜ ì¼ë¶€ì…ë‹ˆë‹¤. ì¡°ê¸‰í•´í•˜ì§€ ë§ˆì„¸ìš”.",
            "ì´ëŸ° ì‹œê°„ë„ ì§€ë‚˜ê°‘ë‹ˆë‹¤. ì§€ê¸ˆì€ ì ì‹œ ë©ˆì¶°ë„ ê´œì°®ì•„ìš”.",
        ],
        "ì¢Œì ˆ_ì••ë°•": [
            "í™”ëŠ” ìì—°ìŠ¤ëŸ¬ìš´ ê°ì •ì´ì—ìš”. ë‹¤ë§Œ ê·¸ê²ƒì— íœ©ì“¸ë¦¬ì§€ ì•Šìœ¼ë©´ ì¢‹ê² ì–´ìš”.",
            "í•œ ê±¸ìŒ ë¬¼ëŸ¬ì„œë©´ ë‹¤ë¥´ê²Œ ë³´ì¼ ìˆ˜ ìˆì–´ìš”.",
            "ì§€ê¸ˆ ì´ ìƒí™©ì´ ì˜ì›í•˜ì§„ ì•Šì•„ìš”. ë•Œë¥¼ ê¸°ë‹¤ë ¤ë³´ì„¸ìš”.",
        ],
        "ë¶€ì •ì _ëŒ€ì¸ê´€ê³„": [
            "ëª¨ë“  ê´€ê³„ê°€ ë‹¤ ë§ì„ ìˆœ ì—†ì–´ìš”. ê±°ë¦¬ë¥¼ ë‘ëŠ” ê²ƒë„ ì§€í˜œì˜ˆìš”.",
            "ì‚¬ëŒ ì‚¬ì´ì˜ ì¼ì€ ì‹œê°„ì´ í•´ê²°í•´ì£¼ê¸°ë„ í•´ìš”.",
            "ë‹¹ì‹ ì˜ ê°€ì¹˜ëŠ” íƒ€ì¸ì˜ í‰ê°€ë¡œ ì •í•´ì§€ì§€ ì•Šì•„ìš”.",
        ],
        "ìê¸°ë¹„í•˜": [
            "ì™„ë²½í•œ ì‚¬ëŒì€ ì—†ì–´ìš”. ë¶€ì¡±í•¨ë„ ë‹¹ì‹ ì˜ ì¼ë¶€ì˜ˆìš”.",
            "ì‹¤ìˆ˜ëŠ” ì„±ì¥ì˜ ê³¼ì •ì´ì—ìš”. ë„ˆë¬´ ìì±…í•˜ì§€ ë§ˆì„¸ìš”.",
            "ìŠ¤ìŠ¤ë¡œë¥¼ ë„ˆê·¸ëŸ½ê²Œ ëŒ€í•´ì£¼ì„¸ìš”. ë‹¹ì‹ ì€ ê·¸ëŸ´ ìê²©ì´ ìˆì–´ìš”.",
        ],
        "ê¸ì •": [
            "ì¢‹ì€ ì—ë„ˆì§€ê°€ ëŠê»´ì§€ë„¤ìš”. ê·¸ í‰ì˜¨í•¨ì„ ì˜¤ë˜ ìœ ì§€í•˜ì„¸ìš”.",
            "ê· í˜• ì¡íŒ í•˜ë£¨ë¥¼ ë³´ë‚´ê³  ê³„ì‹œêµ°ìš”. ì˜í•˜ê³  ìˆì–´ìš”.",
        ],
    },
    
    PersonaType.CHEERFUL_SUPPORTER: {
        "ì •ì„œì _ê³ ê°ˆ": [
            "í˜ë“¤ì—ˆì§€ë§Œ ì—¬ê¸°ê¹Œì§€ ì˜¨ ê±°ì–ì•„ìš”! ëŒ€ë‹¨í•´ìš”!",
            "ì§€ì³ë„ í¬ê¸° ì•ˆ í•˜ëŠ” ë‹¹ì‹ , ì§„ì§œ ë©‹ìˆì–´ìš”!",
            "ì˜¤ëŠ˜ í‘¹ ì‰¬ê³  ë‚´ì¼ ë‹¤ì‹œ ë‹¬ë ¤ë´ìš”! í•  ìˆ˜ ìˆì–´ìš”!",
        ],
        "ì¢Œì ˆ_ì••ë°•": [
            "í™”ë‚˜ëŠ” ê±° ë‹¹ì—°í•´ìš”! ê·¸ë˜ë„ ë‹¹ì‹ ì€ ì˜í•˜ê³  ìˆì–´ìš”!",
            "ìŠ¤íŠ¸ë ˆìŠ¤ ë§ì•˜ì£ ? ê·¸ë˜ë„ ì´ê²¨ë‚¼ ìˆ˜ ìˆì–´ìš”! í˜ë‚´ìš”!",
            "ë‹µë‹µí•˜ì£ ? í•˜ì§€ë§Œ ë‹¹ì‹ ì€ ì¶©ë¶„íˆ ê°•í•´ìš”!",
        ],
        "ë¶€ì •ì _ëŒ€ì¸ê´€ê³„": [
            "ê´€ê³„ ë•Œë¬¸ì— í˜ë“¤ì—ˆì£ ? í•˜ì§€ë§Œ ë‹¹ì‹  í¸ë„ ë¶„ëª… ìˆì–´ìš”!",
            "ì‚¬ëŒ ë•Œë¬¸ì— ì§€ì³¤ì–´ë„, ë‹¹ì‹ ì€ ì—¬ì „íˆ ë©‹ì§„ ì‚¬ëŒì´ì—ìš”!",
            "í˜ë“  ê´€ê³„ëŠ” ì •ë¦¬í•´ë„ ê´œì°®ì•„ìš”! ë‹¹ì‹ ì´ ë” ì†Œì¤‘í•´ìš”!",
        ],
        "ìê¸°ë¹„í•˜": [
            "ë­” ì†Œë¦¬ì˜ˆìš”! ë‹¹ì‹ ì€ ì •ë§ ì˜í•˜ê³  ìˆì–´ìš”!",
            "ì‹¤ìˆ˜? ê´œì°®ì•„ìš”! ë‹¤ìŒì—” ë” ì˜í•  ìˆ˜ ìˆì–´ìš”!",
            "ìì‹ ê° ê°€ì ¸ìš”! ë‹¹ì‹ ì€ ìƒê°ë³´ë‹¤ í›¨ì”¬ ë©‹ì§„ ì‚¬ëŒì´ì—ìš”!",
        ],
        "ê¸ì •": [
            "ì˜¤ëŠ˜ ê¸°ë¶„ ì¢‹ì€ ê±° ë§ì£ ?! ìµœê³ ì˜ˆìš”! ğŸ‘",
            "ê¸ì • ì—ë„ˆì§€ ë¿œë¿œ! ì˜¤ëŠ˜ë„ ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”! âœ¨",
        ],
    },
}


def get_template_feedback(
    persona_type: PersonaType,
    category: str,
    keywords: List[str] = None
) -> str:
    """í…œí”Œë¦¿ ê¸°ë°˜ í”¼ë“œë°± ë°˜í™˜"""
    import random
    
    templates = FEEDBACK_TEMPLATES.get(persona_type, FEEDBACK_TEMPLATES[PersonaType.WARM_COUNSELOR])
    category_templates = templates.get(category, templates.get("ì •ì„œì _ê³ ê°ˆ", []))
    
    if not category_templates:
        return "ì˜¤ëŠ˜ í•˜ë£¨ë„ ìˆ˜ê³ í•˜ì…¨ì–´ìš”."
    
    feedback = random.choice(category_templates)
    
    # í‚¤ì›Œë“œ ì—°ê²° (ë”°ëœ»í•œ ìƒë‹´ì‚¬, ì°¨ë¶„í•œ ë©˜í† ë§Œ)
    if keywords and persona_type in [PersonaType.WARM_COUNSELOR, PersonaType.CALM_MENTOR]:
        keyword_str = ", ".join(keywords[:2])
        feedback += f" '{keyword_str}'ë¼ëŠ” ë§ì”€ì—ì„œ ë§ˆìŒì´ ëŠê»´ì¡Œì–´ìš”."
    
    return feedback


# ============================================
# ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
# ============================================

def get_persona_by_preference(preference: dict) -> PersonaType:
    """
    ì‚¬ìš©ì ì„¤ë¬¸ ê²°ê³¼(preference)ì— ë”°ë¼ ì ì ˆí•œ í˜ë¥´ì†Œë‚˜ ë°˜í™˜
    
    preference ì˜ˆì‹œ:
    {
        "is_active": True,      # í™œë™ì ì¸ì§€
        "is_social": True,      # ì‚¬êµì ì¸ì§€
        "preferred_tone": "warm"  # ì„ í˜¸ í†¤ (ìˆë‹¤ë©´)
    }
    """
    # ì„ í˜¸ í†¤ì´ ëª…ì‹œë˜ì–´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    tone_mapping = {
        "warm": PersonaType.WARM_COUNSELOR,
        "practical": PersonaType.PRACTICAL_ADVISOR,
        "friendly": PersonaType.FRIENDLY_BUDDY,
        "calm": PersonaType.CALM_MENTOR,
        "cheerful": PersonaType.CHEERFUL_SUPPORTER,
    }
    
    if preferred_tone := preference.get("preferred_tone"):
        if preferred_tone in tone_mapping:
            return tone_mapping[preferred_tone]
    
    # ì„ í˜¸ í†¤ì´ ì—†ìœ¼ë©´ ì„±í–¥ì— ë”°ë¼ ì¶”ì²œ
    is_active = preference.get("is_active", False)
    is_social = preference.get("is_social", False)
    
    if is_active and is_social:
        return PersonaType.CHEERFUL_SUPPORTER
    elif is_active and not is_social:
        return PersonaType.PRACTICAL_ADVISOR
    elif not is_active and is_social:
        return PersonaType.FRIENDLY_BUDDY
    else:
        return PersonaType.WARM_COUNSELOR


def list_personas() -> List[dict]:
    """ëª¨ë“  í˜ë¥´ì†Œë‚˜ ëª©ë¡ ë°˜í™˜"""
    return [
        {
            "type": p.type.value,
            "name": p.name,
            "description": p.description,
            "tone": p.tone,
        }
        for p in PERSONAS.values()
    ]


# ============================================
# í…ŒìŠ¤íŠ¸
# ============================================

if __name__ == "__main__":
    # í”„ë¡¬í”„íŠ¸ ë¹Œë” í…ŒìŠ¤íŠ¸
    builder = PromptBuilder(PersonaType.WARM_COUNSELOR)
    
    prompt = builder.build_feedback_prompt(
        category="ì •ì„œì _ê³ ê°ˆ",
        user_text="ì˜¤ëŠ˜ íšŒì‚¬ì—ì„œ ì•¼ê·¼í•˜ê³  ì§‘ì— ì˜¤ë‹ˆê¹Œ 12ì‹œì˜€ì–´. ë„ˆë¬´ ì§€ì¹œë‹¤.",
        keywords=["ì§€ì¹¨", "í”¼ê³¤"],
        activity_name="ë”°ëœ»í•œ ì°¨ ë§ˆì‹œê¸°"
    )
    
    print("=" * 60)
    print("ğŸ­ í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œ (ë”°ëœ»í•œ ìƒë‹´ì‚¬)")
    print("=" * 60)
    print(prompt)
    
    print("\n" + "=" * 60)
    print("ğŸ“ í…œí”Œë¦¿ í”¼ë“œë°± ì˜ˆì‹œ")
    print("=" * 60)
    
    for persona_type in PersonaType:
        feedback = get_template_feedback(
            persona_type=persona_type,
            category="ì¢Œì ˆ_ì••ë°•",
            keywords=["ìŠ¤íŠ¸ë ˆìŠ¤", "í™”ë‚¨"]
        )
        print(f"\n[{PERSONAS[persona_type].name}]")
        print(f"  â†’ {feedback}")
